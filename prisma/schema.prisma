generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("B2BCHAT_DB_PRIMARY_CONNSTRING_PROD")
  directUrl = env("B2BCHAT_DB_DIRECT_URL_PROD")
}

model Company {
  id                     String              @id @default(uuid())
  name                   String
  taxId                  String?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  whatsappNumber         String?
  whatsappPaymentEnabled Boolean             @default(false)
  activatedAt            DateTime?
  activationMethod       String?
  invitationsSent        Int                 @default(0)
  isActivated            Boolean             @default(false)
  lastInvitationSent     DateTime?
  publicInfo             Json?
  
  // Fields for external discovery (Discovery 2.0)
  isProvisional          Boolean             @default(false)
  externalSource         String?             // e.g. "GOOGLE_PLACES", "YELP", "HUNTER"
  externalId             String?             @unique // ID in the external source
  enrichmentData         Json?               // Raw data from external API

  // Economic Profile (Block 3)
  purchasingPower        String?             // LOW, MEDIUM, HIGH, ENTERPRISE
  dealVelocity           String?             // FAST, NORMAL, SLOW
  avgResponseTime        Int?                // Minutes
  reputationScore        Int                 @default(100)

  adCampaigns            AdCampaign[]
  connectionsAsA         CompanyConnection[] @relation("CompanyA")
  connectionsAsB         CompanyConnection[] @relation("CompanyB")
  invitations            CompanyInvitation[]
  conversationsAsA       Conversation[]      @relation("CompanyA")
  conversationsAsB       Conversation[]      @relation("CompanyB")
  subscription           Subscription?
  users                  User[]
}

model User {
  id                     String              @id @default(uuid())
  name                   String
  phone                  String              @unique
  email                  String?             @unique
  passwordHash           String
  companyId              String?
  avatar                 String?
  bio                    String?
  website                String?
  position               String?
  industry               String?
  profilePicture         String?
  isBot                  Boolean             @default(false)
  botPersonality         String?
  
  // Fields for external discovery (Discovery 2.0)
  isGhost                Boolean             @default(false)
  ghostEmail             String?             // Real external email
  ghostPhone             String?             // Real external WhatsApp

  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  resetCode              String?
  resetCodeExpiresAt     DateTime?
  otpCode                String?
  otpExpiresAt           DateTime?
  creditBalance          Float               @default(10.0)
  role                   String              @default("USUARIO")
  planType               String              @default("FREE")
  campaigns              AdCampaign[]
  sentInvitations        CompanyInvitation[] @relation("SentInvitations")
  conversationsAsA       Conversation[]      @relation("UserA")
  conversationsAsB       Conversation[]      @relation("UserB")
  creditTransactions     CreditTransaction[]
  receivedFriendRequests FriendRequest[]     @relation("ReceiverUser")
  sentFriendRequests     FriendRequest[]     @relation("RequesterUser")
  createdGroups          Group[]
  groupMemberships       GroupMember[]
  sentMessages           Message[]
  stores                 Store[]
  // subscription           Subscription? // Moved to Company level
  walletTransactions     Transaction[]       @relation("UserTransactions")
  company                Company?            @relation(fields: [companyId], references: [id])
}

model CreditTransaction {
  id          String   @id @default(uuid())
  userId      String
  amount      Float
  description String
  referenceId String?
  createdAt   DateTime @default(now())
  type        String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CompanyConnection {
  id         String   @id @default(uuid())
  companyAId String
  companyBId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  status     String   @default("PENDING")
  companyA   Company  @relation("CompanyA", fields: [companyAId], references: [id])
  companyB   Company  @relation("CompanyB", fields: [companyBId], references: [id])

  @@unique([companyAId, companyBId])
}

model Conversation {
  id         String    @id @default(uuid())
  companyAId String?
  companyBId String?
  userAId    String?
  userBId    String?
  groupId    String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  type       String
  isFavorite Boolean   @default(false)
  isPinned   Boolean   @default(false)
  companyA   Company?  @relation("CompanyA", fields: [companyAId], references: [id])
  companyB   Company?  @relation("CompanyB", fields: [companyBId], references: [id])
  group      Group?    @relation(fields: [groupId], references: [id])
  userA      User?     @relation("UserA", fields: [userAId], references: [id])
  userB      User?     @relation("UserB", fields: [userBId], references: [id])
  messages   Message[]
  
  // Economic & Intent Signals (Evolution Plan Block 1)
  intentScore     Int       @default(0) // 0-100
  estimatedValue  Float?
  currency        String    @default("USD")
  stage           String    @default("DISCOVERY") // DISCOVERY, QUALIFIED, PROPOSAL, CLOSING, CLOSED
  lastAiAnalysis  DateTime?
  aiSummary       String?
  nextSteps       Json?
  
  // WhatsApp Bridge (Back-to-Back)
  lastChannel     String    @default("INTERNAL") // INTERNAL, EMAIL, WHATSAPP
}

model Group {
  id            String         @id @default(uuid())
  name          String
  description   String?
  avatar        String?
  createdById   String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  conversations Conversation[]
  createdBy     User           @relation(fields: [createdById], references: [id])
  members       GroupMember[]
}

model GroupMember {
  id       String   @id @default(uuid())
  groupId  String
  userId   String
  isAdmin  Boolean  @default(false)
  joinedAt DateTime @default(now())
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([userId])
}

model Transaction {
  id             String   @id @default(cuid())
  userId         String
  type           String
  amount         Float
  recipientPhone String?
  status         String
  externalId     String?
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation("UserTransactions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  senderUserId   String
  text           String
  attachmentUrl  String?
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  isStarred      Boolean      @default(false)
  emailLogs      EmailLog[]
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  sender         User         @relation(fields: [senderUserId], references: [id])

  // WhatsApp/Email Bridge
  channel        String       @default("INTERNAL") // INTERNAL, EMAIL, WHATSAPP, SYSTEM
  externalId     String?      // ID from Twilio/SendGrid
}

model AdCampaign {
  id              String       @id @default(uuid())
  companyId       String
  userId          String
  name            String
  objective       String
  status          String       @default("DRAFT")
  industry        String?
  sector          String?
  targetRoles     String?
  dailyBudget     Float
  durationDays    Int
  totalBudget     Float
  spent           Float        @default(0)
  creativeType    String
  creativeUrl     String?
  creativeText    String?
  impressions     Int          @default(0)
  clicks          Int          @default(0)
  conversions     Int          @default(0)
  startDate       DateTime?
  endDate         DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  paymentMethod   String?
  paymentProofUrl String?
  paymentStatus   String       @default("PENDING_PAYMENT")
  transactionRef  String?
  type            String       @default("STORY")
  company         Company      @relation(fields: [companyId], references: [id])
  user            User         @relation(fields: [userId], references: [id])
  creatives       AdCreative[]
}

model AdCreative {
  id               String     @id @default(uuid())
  campaignId       String
  title            String
  description      String?
  imageUrl         String?
  ctaLabel         String?
  destinationUrl   String?
  ageRange         String?
  gender           String?
  location         String?
  type             String     @default("IMAGE")
  videoUrl         String?
  videoDuration    Int?
  isActive         Boolean    @default(true)
  approvalStatus   String     @default("PENDING")
  displayOrder     Int        @default(0)
  rotationHours    Int?
  lastShownAt      DateTime?
  impressionsCount Int        @default(0)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  duration         Int        @default(5)
  mediaType        String     @default("IMAGE")
  order            Int        @default(0)
  campaign         AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  stats            AdStats?
}

model AdStats {
  id             String     @id @default(uuid())
  adCreativeId   String     @unique
  impressions    Int        @default(0)
  clicks         Int        @default(0)
  whatsappClicks Int        @default(0)
  creative       AdCreative @relation(fields: [adCreativeId], references: [id])
}

model ExternalStore {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  category    String?
  logoUrl     String?
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- SAAS BILLING ENGINE (Fase 1: Data Model) ---

model Plan {
  id            String         @id @default(uuid())
  code          String         @unique // FREE, STARTER, PRO, ENTERPRISE
  name          String
  description   String?
  priceMonthly  Float
  currency      String         @default("USD")
  
  // Feature Gating
  maxUsers      Int            @default(1)
  canUseAI      Boolean        @default(false)
  canUseWhatsApp Boolean       @default(false) // Included whatsapp?
  whatsappLimit Int            @default(0)     // Included messages/convs
  historyDays   Int?           // null = infinite
  
  // Payment Gateways
  stripePriceId String?
  paypalPlanId  String?        // P-XXXXXXXXXXXXXXXXXXXX

  subscriptions Subscription[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Subscription {
  id                   String    @id @default(uuid())
  companyId            String    @unique // One plan per company
  planId               String
  
  status               String    @default("ACTIVE") // ACTIVE, PAST_DUE, CANCELED
  currentPeriodStart   DateTime  @default(now())
  currentPeriodEnd     DateTime? 
  
  // Usage tracking reset monthly
  usageRecords         UsageRecord[]
  addons               AddonPurchase[]
  
  billingProvider      String?   // STRIPE, PAYPAL
  stripeCustomerId     String?
  stripeSubscriptionId String?
  paypalSubscriptionId String?   // I-XXXXXXXXXXXXXXXX

  plan                 Plan      @relation(fields: [planId], references: [id])
  company              Company   @relation(fields: [companyId], references: [id])
  
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

model UsageRecord {
  id             String       @id @default(uuid())
  subscriptionId String
  metric         String       // WHATSAPP_CONVERSATIONS, EMAILS_SENT, AI_QUERIES
  count          Int          @default(0)
  periodStart    DateTime
  periodEnd      DateTime
  
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  
  @@unique([subscriptionId, metric, periodStart])
}

model AddonPurchase {
  id             String       @id @default(uuid())
  subscriptionId String
  type           String       // WHATSAPP_CREDITS_100
  amount         Int          // 100
  remaining      Int          // 100 -> 0
  purchasedAt    DateTime     @default(now())
  expiresAt      DateTime?
  paypalOrderId  String?      // Capture ID
  
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
}

model Store {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  category    String?
  logoUrl     String?
  isFeatured  Boolean   @default(false)
  isActive    Boolean   @default(true)
  ownerUserId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
  owner       User      @relation(fields: [ownerUserId], references: [id])
}

model Product {
  id          String   @id @default(uuid())
  storeId     String
  name        String
  description String?
  price       Float
  currency    String   @default("COP")
  imageUrl    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

model FriendRequest {
  id          String   @id @default(uuid())
  requesterId String
  receiverId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  status      String   @default("PENDING")
  receiver    User     @relation("ReceiverUser", fields: [receiverId], references: [id], onDelete: Cascade)
  requester   User     @relation("RequesterUser", fields: [requesterId], references: [id], onDelete: Cascade)

  @@unique([requesterId, receiverId])
}

model CompanyInvitation {
  id           String    @id @default(uuid())
  companyId    String
  senderUserId String
  message      String
  status       String    @default("PENDING")
  sentAt       DateTime  @default(now())
  viewedAt     DateTime?
  acceptedAt   DateTime?
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sender       User      @relation("SentInvitations", fields: [senderUserId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([senderUserId])
  @@index([status])
}

model EmailLog {
  id             String    @id @default(uuid())
  resendId       String?   @unique
  messageId      String?
  senderUserId   String?
  recipientEmail String
  subject        String
  status         String    @default("SENT")
  openedAt       DateTime?
  clickedAt      DateTime?
  error          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  message        Message?  @relation(fields: [messageId], references: [id])

  @@index([recipientEmail])
  @@index([status])
  @@index([resendId])
}
