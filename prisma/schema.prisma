generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("B2BCHAT_DB_PRIMARY_CONNSTRING_PROD")
  directUrl = env("B2BCHAT_DB_DIRECT_URL_PROD")
}

model Company {
  id                     String              @id @default(uuid())
  name                   String
  taxId                  String?
  whatsappPaymentEnabled Boolean             @default(false)
  whatsappNumber         String?
  isActivated            Boolean             @default(false)
  activatedAt            DateTime?
  activationMethod       String?
  publicInfo             Json?
  invitationsSent        Int                 @default(0)
  lastInvitationSent     DateTime?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  adCampaigns            AdCampaign[]
  connectionsAsA         CompanyConnection[] @relation("CompanyA")
  connectionsAsB         CompanyConnection[] @relation("CompanyB")
  conversationsAsA       Conversation[]      @relation("CompanyA")
  conversationsAsB       Conversation[]      @relation("CompanyB")
  subscription           Subscription?
  users                  User[]
  invitations            CompanyInvitation[]
}

model User {
  id                     String              @id @default(uuid())
  name                   String
  phone                  String              @unique
  email                  String?             @unique
  passwordHash           String
  role                   String              @default("USUARIO")
  companyId              String?
  avatar                 String?
  bio                    String?
  website                String?
  position               String?
  industry               String?
  profilePicture         String?
  isBot                  Boolean             @default(false)
  botPersonality         String?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  resetCode              String?
  resetCodeExpiresAt     DateTime?
  otpCode                String?
  otpExpiresAt           DateTime?
  creditBalance          Float               @default(10.0)
  planType               String              @default("FREE")
  campaigns              AdCampaign[]
  walletTransactions     Transaction[]       @relation("UserTransactions")
  conversationsAsA       Conversation[]      @relation("UserA")
  conversationsAsB       Conversation[]      @relation("UserB")
  creditTransactions     CreditTransaction[]
  receivedFriendRequests FriendRequest[]     @relation("ReceiverUser")
  sentFriendRequests     FriendRequest[]     @relation("RequesterUser")
  sentInvitations        CompanyInvitation[] @relation("SentInvitations")
  createdGroups          Group[]
  groupMemberships       GroupMember[]
  sentMessages           Message[]
  stores                 Store[]
  subscription           Subscription?
  company                Company?            @relation(fields: [companyId], references: [id])
}

model CreditTransaction {
  id          String   @id @default(uuid())
  userId      String
  amount      Float
  type        String
  description String
  referenceId String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CompanyConnection {
  id         String   @id @default(uuid())
  companyAId String
  companyBId String
  status     String   @default("PENDING")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  companyA   Company  @relation("CompanyA", fields: [companyAId], references: [id])
  companyB   Company  @relation("CompanyB", fields: [companyBId], references: [id])

  @@unique([companyAId, companyBId])
}

model Conversation {
  id         String    @id @default(uuid())
  type       String
  companyAId String?
  companyBId String?
  userAId    String?
  userBId    String?
  groupId    String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  companyA   Company?  @relation("CompanyA", fields: [companyAId], references: [id])
  companyB   Company?  @relation("CompanyB", fields: [companyBId], references: [id])
  group      Group?    @relation(fields: [groupId], references: [id])
  userA      User?     @relation("UserA", fields: [userAId], references: [id])
  userB      User?     @relation("UserB", fields: [userBId], references: [id])
  messages   Message[]
}

model Group {
  id            String         @id @default(uuid())
  name          String
  description   String?
  avatar        String?
  createdById   String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  conversations Conversation[]
  createdBy     User           @relation(fields: [createdById], references: [id])
  members       GroupMember[]
}

model GroupMember {
  id       String   @id @default(uuid())
  groupId  String
  userId   String
  isAdmin  Boolean  @default(false)
  joinedAt DateTime @default(now())
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([userId])
}

model Transaction {
  id             String   @id @default(cuid())
  userId         String
  type           String // SEND, RECEIVE, DEPOSIT, WITHDRAW
  amount         Float
  recipientPhone String?
  status         String // PENDING, APPROVED, REJECTED
  externalId     String? // Nequi transaction ID
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation("UserTransactions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  senderUserId   String
  text           String
  attachmentUrl  String?
  readAt         DateTime?
  isStarred      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  sender         User         @relation(fields: [senderUserId], references: [id])
}

model AdCampaign {
  id           String       @id @default(uuid())
  companyId    String
  userId       String
  name         String
  objective    String
  status       String       @default("DRAFT")
  industry     String?
  sector       String?
  targetRoles  String?
  dailyBudget  Float
  durationDays Int
  totalBudget  Float
  spent        Float        @default(0)
  creativeType String
  creativeUrl  String?
  creativeText String?
  impressions  Int          @default(0)
  clicks       Int          @default(0)
  conversions  Int          @default(0)
  startDate    DateTime?
  endDate      DateTime?
  
  // Story Ads & Payment Fields
  type            String    @default("STORY") // STORY, FEED_POST
  paymentStatus   String    @default("PENDING_PAYMENT") // PENDING_PAYMENT, PAIMENT_VERIFICATION, PAID, REJECTED
  paymentMethod   String?   // NEQUI, WHATSAPP, MANUAL
  paymentProofUrl String?
  transactionRef  String?   // External transaction ID or Nequi Ref

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  company      Company      @relation(fields: [companyId], references: [id])
  user         User         @relation(fields: [userId], references: [id])
  creatives    AdCreative[]
}

model AdCreative {
  id               String     @id @default(uuid())
  campaignId       String
  title            String
  description      String?
  imageUrl         String?
  ctaLabel         String?
  destinationUrl   String?
  ageRange         String?
  gender           String?
  location         String?
  type             String     @default("IMAGE") // IMAGE, VIDEO
  mediaType        String     @default("IMAGE") // Redundant but explicit for Story: IMAGE, VIDEO
  videoUrl         String?
  videoDuration    Int?
  duration         Int        @default(5) // Duration in seconds (5s image, Ns video)
  order            Int        @default(0) // Order in the story sequence
  isActive         Boolean    @default(true)
  approvalStatus   String     @default("PENDING")
  displayOrder     Int        @default(0)
  rotationHours    Int?
  lastShownAt      DateTime?
  impressionsCount Int        @default(0)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  campaign         AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  stats            AdStats?
}

model AdStats {
  id             String     @id @default(uuid())
  adCreativeId   String     @unique
  impressions    Int        @default(0)
  clicks         Int        @default(0)
  whatsappClicks Int        @default(0)
  creative       AdCreative @relation(fields: [adCreativeId], references: [id])
}

model ExternalStore {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  category    String?
  logoUrl     String?
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Subscription {
  id                   String    @id @default(uuid())
  userId               String    @unique
  companyId            String?   @unique
  plan                 String    @default("FREE")
  stripeCustomerId     String?
  stripeSubscriptionId String?
  status               String    @default("active")
  currentPeriodEnd     DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  company              Company?  @relation(fields: [companyId], references: [id])
  user                 User      @relation(fields: [userId], references: [id])
}

model Store {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  category    String?
  logoUrl     String?
  isFeatured  Boolean   @default(false)
  isActive    Boolean   @default(true)
  ownerUserId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
  owner       User      @relation(fields: [ownerUserId], references: [id])
}

model Product {
  id          String   @id @default(uuid())
  storeId     String
  name        String
  description String?
  price       Float
  currency    String   @default("COP")
  imageUrl    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

model FriendRequest {
  id          String   @id @default(uuid())
  requesterId String
  receiverId  String
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  receiver    User     @relation("ReceiverUser", fields: [receiverId], references: [id], onDelete: Cascade)
  requester   User     @relation("RequesterUser", fields: [requesterId], references: [id], onDelete: Cascade)

  @@unique([requesterId, receiverId])
}

model CompanyInvitation {
  id           String    @id @default(uuid())
  companyId    String
  senderUserId String
  message      String
  status       String    @default("PENDING")
  sentAt       DateTime  @default(now())
  viewedAt     DateTime?
  acceptedAt   DateTime?

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sender  User    @relation("SentInvitations", fields: [senderUserId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([senderUserId])
  @@index([status])
}

// Enums converted to String for SQLite compatibility

// Original enums: Role, ConnectionStatus, ConversationType, PlanType, TransactionType, FriendRequestStatus
